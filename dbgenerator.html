<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Monster Drop Extractor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    import * as YAML from "https://cdn.skypack.dev/yaml";
    window.safeParseYaml = (text) => {
      try {
        return YAML.parse(text, { prettyErrors: true, uniqueKeys: false });
      } catch {
        try {
          return YAML.parseDocument(text, { prettyErrors: true, uniqueKeys: false }).toJSON() || {};
        } catch {
          return {};
        }
      }
    };
  </script>
</head>
<body class="bg-gray-100 p-8 font-sans">


<!-- Floating Sidebar -->
<div class="fixed top-0 left-0 h-full w-64 bg-gray-800 text-white shadow-lg z-50">
  <div class="p-4 border-b border-gray-700 text-xl font-bold">Pickup Planner</div>

  <div class="p-4">
    <div class="mb-2 font-semibold text-gray-300">Tools:</div>
    <ul class="space-y-1 ml-2 text-sm">
      <li><a href="pickupplanner.html" class="hover:text-blue-300">Pickup Planner</a></li>
      <li><a href="dbgenerator.html" class="hover:text-blue-300">Monster Drop Extractor</a></li>
      <li><a href="yamlmerger.html" class="hover:text-blue-300">Item DB YAML Merger</a></li>
    </ul>

    <div class="mt-4 mb-2 font-semibold text-gray-300">Files:</div>
    <ul class="space-y-1 ml-2 text-sm">
      <li><a target="_blank" href="inputs/monster_drops.json" class="hover:text-blue-300">- monster_drops.json</a></li>
      <li><a target="_blank" href="inputs/monsterlist.txt" class="hover:text-blue-300">- monsterlist.txt</a></li>
      <li><a target="_blank" href="inputs/cleaned_mob_db.yml" class="hover:text-blue-300">- cleaned_mob_db.yml</a></li>
      <li><a target="_blank" href="inputs/merged_items.yml" class="hover:text-blue-300">- merged_items.yml</a></li>
      <li><a target="_blank" href="inputs/item_db_etc.yml" class="hover:text-blue-300">- item_db_etc.yml</a></li>
    </ul>


    <div class="mt-4 mb-2 font-semibold text-gray-300">Bottable Servers (RateMyServer links):</div>
    <ul class="space-y-1 ml-2 text-sm">
      <li><a target="_blank" href="https://rms101.com/index.php?page=detailedlistserver&serid=22939&itv=6&url_sname=Bot%20Party" class="hover:text-blue-300">Bot Party!</a></li>
      <li><a target="_blank" href="https://rms101.com/index.php?page=detailedlistserver&serid=22233&itv=6&url_sname=Asgards%20Glory" class="hover:text-blue-300">Asgards Glory</a></li>
    </ul>

    <div class="mt-4 mb-2 font-semibold text-gray-300">About</div>
    <small>Tools made for Openkore QOL by <a href="https://github.com/junoxjuno">junoxjuno</a></small>

  </div>
</div>

<!-- Add margin-left to your page content -->
<div class="ml-64">
  <div class="max-w-3xl mx-auto bg-white rounded-2xl shadow-xl p-6 space-y-6">
    <div id="progressContainer" class="">
      <div class="mt-4 w-full bg-gray-200 rounded-full h-4">
        <div id="progressBar" class="h-4 bg-blue-600 rounded-full w-0 transition-all duration-300"></div>
      </div>
      <p id="progressText" class="text-sm text-gray-600 mt-2">Reading files...</p>
    </div>

    <h1 class="text-2xl font-bold text-gray-800">Monster Drop Extractor</h1>
    <p>Generates a monster database to be used by the Pickup Planner, in JSON format. Contains the monster details and its dropped items.</p>
    <p>Why make this, instead of keeping up a database? Keeping up a database gives the dev more things to maintain. I pass that to you, the user. ðŸ¤£</p>
    
    <div class="space-y-4">
      <div>
        <label class="block font-semibold text-gray-700">1. Monster IDs (.txt):</label>
        <input type="file" id="monsterIdsFile" accept=".txt" class="mt-1 border p-2 rounded w-full">
        <label class="flex items-center space-x-2 mt-2">
          <input type="checkbox" id="ignoreMonsterList" class="form-checkbox">
          <span class="text-sm text-gray-700">Ignore monster list txt (ignores your uploaded monster id list txt, and parses your entire Monsters YAML file instead.)</span>
        </label>
      </div>

      <div>
        <label class="block font-semibold text-gray-700">2. Monsters YAML:</label>
        <input type="file" id="monstersYamlFile" accept=".yaml,.yml" class="mt-1 border p-2 rounded w-full">
      </div>

      <div>
        <label class="block font-semibold text-gray-700">3. Items YAML:</label>
        <input type="file" id="itemsYamlFile" accept=".yaml,.yml" class="mt-1 border p-2 rounded w-full">
      </div>

      <button onclick="processFiles()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded shadow">
        Process Files
      </button>
    </div>

    <div id="outputSection" class="hidden">
      <p id="processedCount" class="text-sm text-gray-700 mt-2"></p>

      <div class="flex justify-end space-x-2 mt-4">
        <button onclick="copyOutput()" class="bg-gray-700 text-white text-sm px-3 py-1 rounded hover:bg-gray-800">Copy</button>
        <button onclick="downloadOutput()" class="bg-green-600 text-white text-sm px-3 py-1 rounded hover:bg-green-700">Download</button>
      </div>
    </div>
  </div>

</div>



<script>
  let lastJsonOutput = '';

  function readFile(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsText(file);
    });
  }

  function showProgress(percent, label = "") {
    document.getElementById("progressContainer").classList.remove("hidden");
    document.getElementById("progressBar").style.width = percent + "%";
    document.getElementById("progressText").textContent = label;
  }

  function hideProgress() {
    document.getElementById("progressBar").style.width = "100%";
    setTimeout(() => {
      document.getElementById("progressContainer").classList.add("hidden");
    }, 500);
  }

  async function processFiles() {
    const ignoreList = document.getElementById('ignoreMonsterList').checked;
    const idFile = document.getElementById('monsterIdsFile').files[0];
    const monsterYamlFile = document.getElementById('monstersYamlFile').files[0];
    const itemYamlFile = document.getElementById('itemsYamlFile').files[0];
    const outputSection = document.getElementById('outputSection');

    if ((!ignoreList && !idFile) || !monsterYamlFile || !itemYamlFile) {
      alert('Please upload the required files.');
      return;
    }

    try {
      showProgress(5, "Reading files...");
      const [idText, monsterYamlText, itemYamlText] = await Promise.all([
        ignoreList ? null : readFile(idFile),
        readFile(monsterYamlFile),
        readFile(itemYamlFile)
      ]);

      showProgress(20, "Parsing YAML...");
      const monstersYaml = window.safeParseYaml(monsterYamlText);
      const itemsYaml = window.safeParseYaml(itemYamlText);

      if (!monstersYaml?.Body || !itemsYaml?.Body) {
        alert("Error: Invalid YAML structure.");
        return;
      }

      const monsterIds = ignoreList
        ? monstersYaml.Body.map(m => m.Id)
        : idText.trim().split(/\r?\n/).map(id => parseInt(id.trim(), 10)).filter(Boolean);

      const itemMap = {};
      itemsYaml.Body.forEach(item => {
        if (item.AegisName) {
          itemMap[item.AegisName] = { id: item.Id, aegisName: item.AegisName };
        }
      });

      const result = [];
      for (let i = 0; i < monsterIds.length; i++) {
        const id = monsterIds[i];
        const monster = monstersYaml.Body.find(m => m.Id === id);
        if (!monster) continue;

        const drops = [];
        if (Array.isArray(monster.Drops)) {
          for (const drop of monster.Drops) {
            const item = itemMap[drop.Item];
            if (item) {
              drops.push({ id: item.id, name: item.aegisName });
            }
          }
        }

        result.push({
          id: monster.Id,
          name: monster.Name,
          drops
        });

        showProgress(
          30 + Math.floor((i / monsterIds.length) * 60),
          `${i + 1}/${monsterIds.length} - Now processing: ${monster.Name} [${drops.length} items]`
        );
      }

      lastJsonOutput = JSON.stringify(result, null, 2);

      const processedCount = result.length;
      const totalCount = monsterIds.length;
      document.getElementById("processedCount").textContent =
        `âœ… Processed ${processedCount} out of ${totalCount} monsters.`;

      outputSection.classList.remove("hidden");
    } catch (err) {
      alert("Error: " + err.message);
    } finally {
      showProgress(100, "Done!");
      hideProgress();
    }



  }

  function copyOutput() {
    if (!lastJsonOutput) return;
    navigator.clipboard.writeText(lastJsonOutput).then(() => {
      alert("JSON copied to clipboard!");
    });
  }

  function downloadOutput() {
    if (!lastJsonOutput) return;
    const blob = new Blob([lastJsonOutput], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "monster_drops.json";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }
</script>

</body>
</html>
