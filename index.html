<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Monster Item Picker</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6 font-sans">

<!-- Floating Sidebar -->
<div class="fixed top-0 left-0 h-full w-64 bg-gray-800 text-white shadow-lg z-50">
  <div class="p-4 border-b border-gray-700 text-xl font-bold">Pickup Planner</div>
  
  <div class="p-4">
    <div class="mb-2 font-semibold text-gray-300">Tools:</div>
    <ul class="space-y-1 ml-2 text-sm">
      <li><a href="pickupplanner.html" class="hover:text-blue-300">Pickup Planner</a></li>
      <li><a href="dbgenerator.html" class="hover:text-blue-300">Monster Drop Extractor</a></li>
      <li><a href="yamlmerger.html" class="hover:text-blue-300">Item DB YAML Merger</a></li>
    </ul>

    <div class="mt-4 mb-2 font-semibold text-gray-300">Files:</div>
    <ul class="space-y-1 ml-2 text-sm">
      <li><a target="_blank" href="inputs/monster_drops.json" class="hover:text-blue-300">- monster_drops.json</a></li>
      <li><a target="_blank" href="inputs/monsterlist.txt" class="hover:text-blue-300">- monsterlist.txt</a></li>
      <li><a target="_blank" href="inputs/cleaned_mob_db.yml" class="hover:text-blue-300">- cleaned_mob_db.yml</a></li>
      <li><a target="_blank" href="inputs/merged_items.yml" class="hover:text-blue-300">- merged_items.yml</a></li>
      <li><a target="_blank" href="inputs/item_db_etc.yml" class="hover:text-blue-300">- item_db_etc.yml</a></li>
    </ul>


    <div class="mt-4 mb-2 font-semibold text-gray-300">Bottable Servers (RateMyServer links):</div>
    <ul class="space-y-1 ml-2 text-sm">
      <li><a target="_blank" href="https://rms101.com/index.php?page=detailedlistserver&serid=22939&itv=6&url_sname=Bot%20Party" class="hover:text-blue-300">Bot Party!</a></li>
      <li><a target="_blank" href="https://rms101.com/index.php?page=detailedlistserver&serid=22233&itv=6&url_sname=Asgards%20Glory" class="hover:text-blue-300">Asgards Glory</a></li>
    </ul>

    <div class="mt-4 mb-2 font-semibold text-gray-300">About</div>
    <small>Tools made for Openkore QOL by <a href="https://github.com/junoxjuno">junoxjuno</a></small>

  </div>
</div>


<!-- Optional: Push page content right to make room -->
<div class="ml-64 p-6">

  <div class="max-w-5xl mx-auto bg-white p-6 rounded-xl shadow space-y-6">
    <h1 class="text-2xl font-bold">Monster Item Picker</h1>
    <p>Generates a <code>pickupitems.txt</code> list based on what items you select in the UI from a list of monsters you provide. Input file formatting are provided in the Files links in the Sidebar.</p>

    <!-- File Uploads -->
    <div class="space-y-4">
      <div>
        <label class="block font-semibold">1. Monster ID List (.txt):</label>
        <input type="file" id="monsterIdsFile" accept=".txt" class="w-full p-2 border rounded">
      </div>
      <div>
        <label class="block font-semibold">2. Monster Drop JSON:</label>
        <input type="file" id="monsterJsonFile" accept=".json" class="w-full p-2 border rounded">
      </div>
      <button onclick="processFiles()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Process</button>
    </div>

    <!-- Results -->
    <div id="results" class="hidden space-y-6">
      <!-- Monster List -->
      <div>
        <h2 class="text-xl font-semibold">Monster List</h2>
        <ul id="monsterList" class="list-disc pl-6 text-gray-700"></ul>
      </div>

      <!-- Item Table -->
      <div>
        <h2 class="text-xl font-semibold">Item Drops</h2>
        <button onclick="toggleAllCheckboxes()" class="mb-2 px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 text-sm">Toggle All</button>
        <table class="min-w-full border text-sm text-left">
          <thead>
            <tr class="bg-gray-200">
              <th class="px-4 py-2">Name</th>
              <th class="px-4 py-2">Pick Up?</th>
            </tr>
          </thead>
          <tbody id="itemsTable" class="bg-white divide-y"></tbody>
        </table>
      </div>

      <!-- Output -->
      <div>
        <h2 class="text-xl font-semibold">Output</h2>
        <textarea id="outputText" class="w-full h-64 p-2 border rounded font-mono text-sm" readonly></textarea>
        <button onclick="downloadOutput()" class="mt-2 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Download .txt</button>
      </div>
    </div>
  </div>
</div>


  <script>
    let allItemsMap = new Map();

    async function readFileAsText(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = reject;
        reader.readAsText(file);
      });
    }

    async function processFiles() {
      const idsFile = document.getElementById('monsterIdsFile').files[0];
      const jsonFile = document.getElementById('monsterJsonFile').files[0];
      if (!idsFile || !jsonFile) {
        alert("Please upload both files.");
        return;
      }

      const idText = await readFileAsText(idsFile);
      const jsonText = await readFileAsText(jsonFile);
      const idList = idText.trim().split(/\r?\n/).map(Number);
      const monsterData = JSON.parse(jsonText);

      const matchingMonsters = monsterData.filter(m => idList.includes(m.id));

      // Monster list UI
      const monsterListEl = document.getElementById("monsterList");
      monsterListEl.innerHTML = "";
      matchingMonsters.forEach(mon => {
        const li = document.createElement("li");
        li.textContent = mon.name;
        monsterListEl.appendChild(li);
      });

      // Collect unique items
      allItemsMap = new Map();
      matchingMonsters.forEach(mon => {
        mon.drops.forEach(drop => {
          if (!allItemsMap.has(drop.id)) {
            allItemsMap.set(drop.id, drop.name);
          }
        });
      });

      // Populate item table
      const itemsTable = document.getElementById("itemsTable");
      itemsTable.innerHTML = "";
      allItemsMap.forEach((name, id) => {
        const tr = document.createElement("tr");

        const tdName = document.createElement("td");
        tdName.className = "px-4 py-2";
        tdName.innerHTML = `
            <div class="flex items-center space-x-2">
                <img src="https://static.divine-pride.net/images/items/item/${id}.png" alt="${name}" class="w-6 h-6 object-contain">
                <span>${name} (${id})</span>
            </div>`;

        const tdCheck = document.createElement("td");
        tdCheck.className = "px-4 py-2";
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.checked = name.endsWith("_Card");
        checkbox.dataset.itemId = id;
        checkbox.dataset.itemName = name;
        tdCheck.appendChild(checkbox);

        tr.appendChild(tdName);
        tr.appendChild(tdCheck);
        itemsTable.appendChild(tr);
      });

      document.getElementById("results").classList.remove("hidden");
      generateOutput();
    }

    function toggleAllCheckboxes() {
      const checkboxes = document.querySelectorAll("#itemsTable input[type=checkbox]");
      const allChecked = [...checkboxes].every(cb => cb.checked);
      checkboxes.forEach(cb => cb.checked = !allChecked);
      generateOutput();
    }

    function generateOutput() {
      const checkboxes = document.querySelectorAll("#itemsTable input[type=checkbox]");
      const lines = [];
      checkboxes.forEach(cb => {
        const id = cb.dataset.itemId;
        const name = cb.dataset.itemName;
        const val = cb.checked ? 1 : -1;
        lines.push(`${id} ${val} #${name}`);
      });
      document.getElementById("outputText").value = lines.join("\n");
    }

    function downloadOutput() {
      const text = document.getElementById("outputText").value;
      const blob = new Blob([text], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "item_pickups.txt";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    document.addEventListener("change", (e) => {
      if (e.target.matches("#itemsTable input[type=checkbox]")) {
        generateOutput();
      }
    });
  </script>
</body>
</html>
